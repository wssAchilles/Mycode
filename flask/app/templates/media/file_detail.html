{% extends "base.html" %}

{% block title %}{{ media_file.filename }} - 文件详情 - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
.file-detail-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 0;
    margin-bottom: 30px;
}

.file-preview-large {
    background: white;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.file-preview-large img {
    max-width: 100%;
    max-height: 400px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.file-preview-large video {
    max-width: 100%;
    max-height: 400px;
    border-radius: 10px;
}

.file-preview-large audio {
    width: 100%;
    max-width: 500px;
}

.file-icon-large {
    font-size: 6rem;
    color: #6c757d;
    margin-bottom: 20px;
}

.file-info-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.info-item {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e9ecef;
}

.info-item:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.info-icon {
    width: 40px;
    text-align: center;
    margin-right: 15px;
    color: #667eea;
}

.info-content {
    flex: 1;
}

.info-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 2px;
}

.info-value {
    color: #6c757d;
}

.file-actions {
    background: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.action-btn {
    margin-bottom: 10px;
    margin-right: 10px;
}

.file-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.file-tag {
    background: #e9ecef;
    color: #495057;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    text-decoration: none;
    transition: all 0.3s ease;
}

.file-tag:hover {
    background: #667eea;
    color: white;
    text-decoration: none;
}

.usage-info {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.usage-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 10px;
    background: white;
    border-radius: 8px;
    text-decoration: none;
    color: inherit;
    transition: all 0.3s ease;
}

.usage-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    text-decoration: none;
    color: inherit;
}

.usage-icon {
    width: 40px;
    text-align: center;
    margin-right: 15px;
    color: #28a745;
}

.usage-content {
    flex: 1;
}

.usage-title {
    font-weight: 600;
    margin-bottom: 2px;
}

.usage-meta {
    font-size: 0.8rem;
    color: #6c757d;
}

.copy-url-section {
    background: #e8f4f8;
    border-left: 4px solid #17a2b8;
    padding: 15px;
    border-radius: 0 8px 8px 0;
    margin-bottom: 20px;
}

.url-input-group {
    display: flex;
    margin-top: 10px;
}

.url-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 5px 0 0 5px;
    background: white;
    font-family: monospace;
    font-size: 0.9rem;
}

.copy-btn {
    padding: 8px 15px;
    border: 1px solid #17a2b8;
    border-left: none;
    border-radius: 0 5px 5px 0;
    background: #17a2b8;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.copy-btn:hover {
    background: #138496;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
    display: block;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
}

@media (max-width: 768px) {
    .file-preview-large {
        padding: 20px;
    }
    
    .file-info-card,
    .file-actions {
        padding: 20px;
    }
    
    .info-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .info-icon {
        margin-bottom: 10px;
    }
    
    .url-input-group {
        flex-direction: column;
    }
    
    .url-input {
        border-radius: 5px;
        margin-bottom: 10px;
        border-right: 1px solid #dee2e6;
    }
    
    .copy-btn {
        border-radius: 5px;
        border: 1px solid #17a2b8;
    }
}
</style>
{% endblock %}

{% block content %}
<body class="{% if media_file.is_image or media_file.is_video %}previewable{% endif %}">
<!-- 文件详情头部 -->
<div class="file-detail-container">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('media.index') }}" class="text-white">媒体库</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            {{ media_file.filename }}
                        </li>
                    </ol>
                </nav>
                <h2><i class="fas fa-file"></i> {{ media_file.filename }}</h2>
                <p class="mb-0">
                    由 <strong>{{ media_file.uploader.username }}</strong> 
                    上传于 {{ media_file.uploaded_at.strftime('%Y年%m月%d日 %H:%M') }}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- 文件预览 -->
        <div class="col-lg-8">
            <div class="file-preview-large">
                {% if media_file.is_image %}
                    <img src="{{ media_file.file_url }}" 
                         alt="{{ media_file.alt_text or media_file.filename }}" 
                         class="img-fluid">
                {% elif media_file.is_video %}
                    <video controls class="w-100">
                        <source src="{{ media_file.file_url }}" type="{{ media_file.mime_type }}">
                        您的浏览器不支持视频播放。
                    </video>
                {% elif media_file.is_audio %}
                    <div class="file-icon-large">
                        <i class="fas fa-music"></i>
                    </div>
                    <h4>{{ media_file.filename }}</h4>
                    <audio controls class="w-100 mt-3">
                        <source src="{{ media_file.file_url }}" type="{{ media_file.mime_type }}">
                        您的浏览器不支持音频播放。
                    </audio>
                {% else %}
                    <div class="file-icon-large">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <h4>{{ media_file.filename }}</h4>
                    <p class="text-muted">{{ media_file.mime_type }}</p>
                {% endif %}
            </div>

            <!-- 文件描述 -->
            {% if media_file.description %}
            <div class="file-info-card">
                <h5><i class="fas fa-align-left"></i> 描述</h5>
                <p class="mb-0">{{ media_file.description }}</p>
            </div>
            {% endif %}

            <!-- 文件标签 -->
            {% if media_file.get_tags_list() %}
            <div class="file-info-card">
                <h5><i class="fas fa-tags"></i> 标签</h5>
                <div class="file-tags">
                    {% for tag in media_file.get_tags_list() %}
                    <a href="{{ url_for('media.index', keyword=tag) }}" class="file-tag">{{ tag }}</a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- 使用记录 -->
            {% if associated_posts %}
            <div class="file-info-card">
                <h5><i class="fas fa-link"></i> 使用记录</h5>
                <div class="usage-info">
                    {% for post_media in associated_posts %}
                    <a href="{{ url_for('blog.post', id=post_media.post.id) }}" class="usage-item">
                        <div class="usage-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="usage-content">
                            <div class="usage-title">{{ post_media.post.title }}</div>
                            <div class="usage-meta">
                                用作: {{ post_media.usage_type }} | 
                                发布时间: {% if post_media.post.published_at %}{{ post_media.post.published_at.strftime('%Y-%m-%d') }}{% else %}{{ post_media.post.created_at.strftime('%Y-%m-%d') }}{% endif %}
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- 侧边栏信息 -->
        <div class="col-lg-4">
            <!-- 文件操作 -->
            <div class="file-actions">
                <h5><i class="fas fa-tools"></i> 操作</h5>
                
                <a href="{{ media_file.file_url }}" target="_blank" 
                   class="btn btn-primary action-btn">
                    <i class="fas fa-external-link-alt"></i> 在新窗口打开
                </a>
                
                <a href="{{ url_for('media.download_file', file_id=media_file.id) }}" 
                   class="btn btn-success action-btn">
                    <i class="fas fa-download"></i> 下载文件
                </a>
                
                {% if media_file.uploaded_by == current_user.id or current_user.is_admin %}
                <a href="{{ url_for('media.edit_file', file_id=media_file.id) }}" 
                   class="btn btn-warning action-btn">
                    <i class="fas fa-edit"></i> 编辑信息
                </a>
                
                <button type="button" class="btn btn-danger action-btn" 
                        onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> 删除文件
                </button>
                {% endif %}
                
                <!-- 添加分享功能 -->
                <div class="share-section mb-4">
                    <h5><i class="fas fa-share-alt"></i> 分享</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary" onclick="shareToWeChat()">
                            <i class="fab fa-weixin"></i> 微信
                        </button>
                        <button class="btn btn-outline-secondary" onclick="shareToQQ()">
                            <i class="fab fa-qq"></i> QQ
                        </button>
                        <button class="btn btn-outline-secondary" onclick="shareToWeibo()">
                            <i class="fab fa-weibo"></i> 微博
                        </button>
                    </div>
                </div>
            </div>

            <!-- 复制链接 -->
            <div class="file-info-card">
                <div class="copy-url-section">
                    <h6><i class="fas fa-link"></i> 文件链接</h6>
                    <div class="url-input-group">
                        <input type="text" class="url-input" id="file-url" 
                               value="{{ request.url_root[:-1] + media_file.file_url }}" readonly>
                        <button class="copy-btn" onclick="copyFileUrl()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                {% if media_file.is_image %}
                <div class="copy-url-section">
                    <h6><i class="fas fa-code"></i> Markdown 格式</h6>
                    <div class="url-input-group">
                        <input type="text" class="url-input" id="markdown-code" 
                               value="![{{ media_file.alt_text or media_file.filename }}]({{ request.url_root[:-1] + media_file.file_url }})" readonly>
                        <button class="copy-btn" onclick="copyMarkdown()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="copy-url-section">
                    <h6><i class="fas fa-code"></i> HTML 格式</h6>
                    <div class="url-input-group">
                        <input type="text" class="url-input" id="html-code" 
                               value='<img src="{{ request.url_root[:-1] + media_file.file_url }}" alt="{{ media_file.alt_text or media_file.filename }}">' readonly>
                        <button class="copy-btn" onclick="copyHtml()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- 文件信息 -->
            <div class="file-info-card">
                <h5><i class="fas fa-info-circle"></i> 文件信息</h5>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">文件类型</div>
                        <div class="info-value">{{ media_file.file_type.title() }} ({{ media_file.mime_type }})</div>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-hdd"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">文件大小</div>
                        <div class="info-value">{{ media_file.formatted_size }}</div>
                    </div>
                </div>
                
                {% if media_file.dimensions %}
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">尺寸</div>
                        <div class="info-value">{{ media_file.dimensions.replace(',', ' × ') }} 像素</div>
                    </div>
                </div>
                {% endif %}
                
                {% if media_file.duration %}
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">时长</div>
                        <div class="info-value">{{ media_file.duration // 60 }}:{{ '%02d' % (media_file.duration % 60) }}</div>
                    </div>
                </div>
                {% endif %}
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">上传者</div>
                        <div class="info-value">{{ media_file.uploader.username }}</div>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">上传时间</div>
                        <div class="info-value">{{ media_file.uploaded_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">访问次数</div>
                        <div class="info-value">{{ media_file.download_count }}</div>
                    </div>
                </div>
                
                {% if media_file.last_accessed %}
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">最后访问</div>
                        <div class="info-value">{{ media_file.last_accessed.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                    </div>
                </div>
                {% endif %}
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="info-content">
                        <div class="info-label">可见性</div>
                        <div class="info-value">
                            {% if media_file.is_public %}
                                <span class="text-success">公开</span>
                            {% else %}
                                <span class="text-warning">私有</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
{% if media_file.uploaded_by == current_user.id or current_user.is_admin %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除文件 <strong>{{ media_file.filename }}</strong> 吗？</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    此操作无法撤销，文件将被永久删除。
                </p>
                {% if associated_posts %}
                <p class="text-warning">
                    <i class="fas fa-info-circle"></i> 
                    注意：此文件正在被 {{ associated_posts|length }} 篇文章使用。
                </p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form method="POST" action="{{ url_for('media.delete_file', file_id=media_file.id) }}" style="display: inline;">
                    {{ csrf_token() }}
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 添加预览模态框 -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ media_file.filename }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                {% if media_file.is_image %}
                <img src="{{ media_file.file_url }}" class="img-fluid" alt="{{ media_file.alt_text }}">
                {% elif media_file.is_video %}
                <video controls class="w-100">
                    <source src="{{ media_file.file_url }}" type="{{ media_file.mime_type }}">
                </video>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 初始化键盘快捷键
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('keydown', function(e) {
        // 只处理特定按键
        if (e.key !== 'Escape' && e.key !== ' ') return;
        
        // Esc键 - 关闭所有打开的模态框
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal.show');
            modals.forEach(function(modal) {
                bootstrap.Modal.getInstance(modal).hide();
            });
            return;
        }
        
        // 空格键 - 预览文件
        if (e.key === ' ') {
            const previewModal = document.getElementById('previewModal');
            if (!previewModal) return;
            
            // 检查是否有预览内容
            const hasPreviewContent = previewModal.querySelector('img, video');
            if (hasPreviewContent) {
                e.preventDefault();
                new bootstrap.Modal(previewModal).show();
            }
        }
    });
});

function copyFileUrl() {
    const input = document.getElementById('file-url');
    input.select();
    document.execCommand('copy');
    showSuccess('文件链接已复制到剪贴板');
}

function copyMarkdown() {
    const input = document.getElementById('markdown-code');
    input.select();
    document.execCommand('copy');
    showSuccess('Markdown 代码已复制到剪贴板');
}

function copyHtml() {
    const input = document.getElementById('html-code');
    input.select();
    document.execCommand('copy');
    showSuccess('HTML 代码已复制到剪贴板');
}

function confirmDelete() {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// 添加分享功能
function shareToWeChat() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{ media_file.filename }}');
    const image = encodeURIComponent('{{ media_file.thumbnail_url or media_file.file_url }}');
    window.open(`https://connect.qq.com/widget/shareqq/index.html?url=${url}&title=${title}&pics=${image}`);
}

function shareToQQ() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{ media_file.filename }}');
    window.open(`https://connect.qq.com/widget/shareqq/index.html?url=${url}&title=${title}`);
}

function shareToWeibo() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{ media_file.filename }}');
    window.open(`https://service.weibo.com/share/share.php?url=${url}&title=${title}`);
}
</script>
{% endblock %}
