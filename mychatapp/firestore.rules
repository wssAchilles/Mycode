rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ” å®‰å…¨çš„èŠå¤©è½¯ä»¶è§„åˆ™ - ç¬¦åˆéšç§ä¿æŠ¤è¦æ±‚

    // --- ç”¨æˆ·é›†åˆ (users) ---
    match /users/{userId} {
      // ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥è¯»å–å…¶ä»–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼ˆç”¨äºæ·»åŠ å¥½å‹ã€æ˜¾ç¤ºè”ç³»äººï¼‰
      allow read: if request.auth != null;
      // åªæœ‰ç”¨æˆ·æœ¬äººæ‰èƒ½åˆ›å»ºå’Œæ›´æ–°è‡ªå·±çš„æ•°æ®
      allow create, update: if request.auth != null && request.auth.uid == userId;
      // ä¸å…è®¸åˆ é™¤ç”¨æˆ·ï¼ˆé€šè¿‡åº”ç”¨é€»è¾‘å¤„ç†ï¼‰
      allow delete: if false;
    }

    // --- å¥½å‹è¯·æ±‚é›†åˆ (friend_requests) ---
    match /friend_requests/{requestId} {
      // åªèƒ½æŸ¥çœ‹ä¸è‡ªå·±ç›¸å…³çš„å¥½å‹è¯·æ±‚ï¼ˆå‘é€çš„æˆ–æ¥æ”¶çš„ï¼‰
      allow read: if request.auth != null && 
                  (resource.data.senderId == request.auth.uid || 
                   resource.data.receiverId == request.auth.uid);
      // åªèƒ½åˆ›å»ºè‡ªå·±å‘é€çš„å¥½å‹è¯·æ±‚
      allow create: if request.auth != null && 
                    request.auth.uid == request.resource.data.senderId;
      // åªæœ‰æ¥æ”¶è€…æ‰èƒ½æ›´æ–°è¯·æ±‚çŠ¶æ€ï¼ˆæ¥å—/æ‹’ç»ï¼‰
      allow update: if request.auth != null && 
                    request.auth.uid == resource.data.receiverId;
      // ä¸å…è®¸åˆ é™¤å¥½å‹è¯·æ±‚
      allow delete: if false;
    }

    // --- èŠå¤©å®¤é›†åˆ (chat_rooms) ---
    match /chat_rooms/{chatRoomId} {
      // ğŸ”‘ æ ¸å¿ƒå®‰å…¨è§„åˆ™ï¼šåªæœ‰èŠå¤©å®¤å‚ä¸è€…æ‰èƒ½è®¿é—®
      allow read: if request.auth != null && 
                     request.auth.uid in resource.data.participantIds;
      
      // ğŸ” æŸ¥è¯¢æƒé™ï¼šåªèƒ½æŸ¥è¯¢è‡ªå·±å‚ä¸çš„èŠå¤©å®¤
      allow list: if request.auth != null && 
                     request.query.where.get('participantIds').get('array-contains') == request.auth.uid;
      
      // åªæœ‰å‚ä¸è€…æ‰èƒ½åˆ›å»ºèŠå¤©å®¤ï¼ˆé€šè¿‡åº”ç”¨é€»è¾‘ç¡®ä¿å¥½å‹å…³ç³»ï¼‰
      allow create: if request.auth != null && 
                       request.auth.uid in request.resource.data.participantIds;
      
      // åªæœ‰å‚ä¸è€…æ‰èƒ½æ›´æ–°èŠå¤©å®¤ä¿¡æ¯ï¼ˆå¦‚æœªè¯»æ•°ç­‰ï¼‰
      allow update: if request.auth != null && 
                       request.auth.uid in resource.data.participantIds;
      
      // ä¸å…è®¸åˆ é™¤èŠå¤©å®¤ï¼ˆé€šè¿‡åº”ç”¨é€»è¾‘å¤„ç†ï¼‰
      allow delete: if false;
      
      // --- æ¶ˆæ¯å­é›†åˆ (messages) ---
      match /messages/{messageId} {
        // ğŸ”’ æœ€ä¸¥æ ¼çš„æ¶ˆæ¯å®‰å…¨ï¼šåªæœ‰èŠå¤©å®¤å‚ä¸è€…æ‰èƒ½è¯»å–æ¶ˆæ¯
        allow read: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.participantIds;
        
        // æŸ¥è¯¢æ¶ˆæ¯åˆ—è¡¨ï¼šåŒæ ·éœ€è¦æ˜¯å‚ä¸è€…
        allow list: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.participantIds;
        
        // åªæœ‰å‚ä¸è€…æ‰èƒ½å‘é€æ¶ˆæ¯ï¼Œä¸”å‘é€è€…IDå¿…é¡»æ˜¯å½“å‰ç”¨æˆ·
        allow create: if request.auth != null && 
                         request.auth.uid in get(/databases/$(database)/documents/chat_rooms/$(chatRoomId)).data.participantIds &&
                         request.auth.uid == request.resource.data.senderId;
        
        // ä¸å…è®¸ä¿®æ”¹æˆ–åˆ é™¤å·²å‘é€çš„æ¶ˆæ¯
        allow update, delete: if false;
      }
    }

    // --- ç¾¤ç»„é›†åˆ (groups) ---
    match /groups/{groupId} {
      // åªæœ‰ç¾¤æˆå‘˜æ‰èƒ½è¯»å–ç¾¤ä¿¡æ¯
      allow read: if request.auth != null && 
                     request.auth.uid in resource.data.participantIds;
      
      // æŸ¥è¯¢ï¼šåªèƒ½æŸ¥è¯¢è‡ªå·±åŠ å…¥çš„ç¾¤ç»„
      allow list: if request.auth != null && 
                     request.query.where.get('participantIds').get('array-contains') == request.auth.uid;
      
      // åˆ›å»ºç¾¤ç»„ï¼šåˆ›å»ºè€…å¿…é¡»æ˜¯æˆå‘˜å’Œç®¡ç†å‘˜
      allow create: if request.auth != null && 
                       request.auth.uid in request.resource.data.participantIds &&
                       request.auth.uid in request.resource.data.adminIds;
      
      // åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ›´æ–°ç¾¤ä¿¡æ¯
      allow update: if request.auth != null && 
                       request.auth.uid in resource.data.adminIds;
      
      // ä¸å…è®¸åˆ é™¤ç¾¤ç»„
      allow delete: if false;
      
      // --- ç¾¤æ¶ˆæ¯å­é›†åˆ (messages) ---
      match /messages/{messageId} {
        // åªæœ‰ç¾¤æˆå‘˜æ‰èƒ½è¯»å–ç¾¤æ¶ˆæ¯
        allow read: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.participantIds;
        
        // æŸ¥è¯¢ç¾¤æ¶ˆæ¯ï¼šéœ€è¦æ˜¯ç¾¤æˆå‘˜
        allow list: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.participantIds;
        
        // åªæœ‰ç¾¤æˆå‘˜æ‰èƒ½å‘æ¶ˆæ¯ï¼Œä¸”å‘é€è€…IDå¿…é¡»åŒ¹é…
        allow create: if request.auth != null && 
                         request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.participantIds &&
                         request.auth.uid == request.resource.data.senderId;
        
        // ä¸å…è®¸ä¿®æ”¹æˆ–åˆ é™¤ç¾¤æ¶ˆæ¯
        allow update, delete: if false;
      }
    }

    // --- åª’ä½“é™„ä»¶é›†åˆ (media_attachments) ---
    match /media_attachments/{attachmentId} {
      // åªæœ‰ä¸Šä¼ è€…æ‰èƒ½è¯»å–å’Œä¿®æ”¹è‡ªå·±çš„é™„ä»¶
      allow read, create, update: if request.auth != null && 
                                     request.auth.uid == resource.data.uploadedBy;
      allow delete: if false;
    }

    // --- é€šçŸ¥é›†åˆ (notifications) ---
    match /notifications/{notificationId} {
      // åªæœ‰æ¥æ”¶è€…æ‰èƒ½è¯»å–å’Œæ›´æ–°è‡ªå·±çš„é€šçŸ¥
      allow read, update: if request.auth != null && 
                             request.auth.uid == resource.data.recipientId;
      // ç³»ç»Ÿå¯ä»¥åˆ›å»ºé€šçŸ¥ï¼ˆé€šè¿‡Cloud Functionsï¼‰
      allow create: if request.auth != null;
      allow delete: if false;
    }
  }
}