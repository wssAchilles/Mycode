# 项目配置手册（Telegram 全栈 + ML）

更新时间：2026-01-27 · 适用路径：`/Users/achilles/Documents/telegram/telegram`

## 服务与目录

- `telegram-clone-backend/`：Node.js + Express + Socket.IO，TypeScript 构建到 `dist/`。
- `telegram-clone-frontend/`：React 19 + Vite 7 + TypeScript，构建产物在 `dist/`（Vercel 部署）。
- `ml-services/`：Python 3.11 FastAPI 推理服务 + 训练脚本（Two-Tower 召回、Phoenix 排序、VF 安全过滤），可单独容器化。
- 根目录 `.env` 同时被后端与前端（通过 Vite 的 `envDir: '..'`）读取；ML 侧可通过相对路径加载同一份 `.env`。

## 运行依赖与端口

- Node.js ≥ 18 / npm ≥ 9（前后端）。
- Python 3.11（ML）。
- 数据层：MongoDB Atlas、PostgreSQL（Supabase 或本地）、Redis（Upstash 或本地）。
- 默认端口：后端 HTTP `5000`（Render 上 `10000`），AI Socket `5850`（可禁用），前端 Vite Dev `5173`，ML FastAPI `8000`。

## 环境变量

> 建议集中放在根目录 `.env`，前端需以 `VITE_` 前缀暴露。下面给出按服务拆分的清单（均需自行填值，未写默认则为必填）。

### 当前生产配置（源自项目根目录 `.env`，敏感值已打码）

- 运行环境：`NODE_ENV=production`，`PORT=10000`
- PostgreSQL：`postgresql://postgres.cozmwcslflwnzvcydmgb:%40********@aws-0-us-west-2.pooler.supabase.com:5432/postgres`
- Redis：`rediss://default:********@true-filly-39588.upstash.io:6379`
- MongoDB：`mongodb+srv://Telegram:******@telegram.wtcymhw.mongodb.net/telegram_clone?...`
- JWT：`JWT_SECRET=<64-byte hex>`，`JWT_EXPIRES_IN=7d`
- AI：`AI_SOCKET_ENABLED=false`（Socket 已禁用，走 HTTP）
- Gemini：`GEMINI_API_KEY=AIzaSy***************`
- ML 服务：`ANN_ENDPOINT / PHOENIX_ENDPOINT / VF_ENDPOINT` 指向 `https://telegram-ml-services.onrender.com/*`
- 前端/后端域名：`FRONTEND_URL=https://telegram-liart-rho.vercel.app`，`BACKEND_URL=https://telegram-clone-backend-88ez.onrender.com`
- 前端运行时：`VITE_API_BASE_URL=https://telegram-clone-backend-88ez.onrender.com`，`VITE_SOCKET_URL=https://telegram-clone-backend-88ez.onrender.com`

### 后端必需

| 变量               | 说明               | 默认 / 备注                                                        |
| ------------------ | ------------------ | ------------------------------------------------------------------ |
| `NODE_ENV`       | 运行环境           | `development`（Render 为 `production`）                        |
| `PORT`           | HTTP 端口          | 5000（Render `10000`）                                           |
| `MONGODB_URI`    | Mongo 连接串       | 必填，支持 `mongodb+srv://`                                      |
| `DATABASE_URL`   | PostgreSQL 直连串  | 若缺省则走 `PG_HOST/PG_PORT/PG_USERNAME/PG_PASSWORD/PG_DATABASE` |
| `REDIS_URL`      | Redis 连接         | 用于 BullMQ、Pub/Sub、事件流等                                     |
| `JWT_SECRET`     | ≥16 字符签名秘钥  | 必填                                                               |
| `GEMINI_API_KEY` | Google Gemini 密钥 | AI 聊天必需                                                        |

### 后端可选 / 调优

| 变量                                                            | 用途                                                                                                                                                                                                    | 默认                           |
| --------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------ |
| `AI_SOCKET_ENABLED`                                           | 是否启用 AI Socket 服务器                                                                                                                                                                               | `true`（生产建议 `false`） |
| `AI_SOCKET_PORT`                                              | AI Socket 端口                                                                                                                                                                                          | `5850`                       |
| `JWT_EXPIRES_IN`                                              | 访问令牌有效期                                                                                                                                                                                          | `15m`                        |
| `JWT_REFRESH_EXPIRES_IN`                                      | 刷新令牌有效期                                                                                                                                                                                          | `7d`                         |
| `ANN_ENDPOINT`                                                | Two-Tower 召回服务 URL                                                                                                                                                                                  | 若未设则本地回退               |
| `PHOENIX_ENDPOINT`                                            | Phoenix 排序服务 URL                                                                                                                                                                                    | 未设则停用打分器               |
| `VF_ENDPOINT`                                                 | 安全过滤服务 URL                                                                                                                                                                                        | 未设则仅用 `isNsfw` 回退     |
| `MONGODB_*`                                                   | 连接调优：`SERVER_SELECTION_TIMEOUT_MS`/`SOCKET_TIMEOUT_MS`/`CONNECT_TIMEOUT_MS`/`MAX_POOL_SIZE`/`FORCE_IPV4`/`TLS_ALLOW_INVALID_CERTIFICATES`/`DIRECT_CONNECTION`/`RECONNECT_DELAY_MS` | 见 `src/config/db.ts`        |
| `PG_HOST/PG_PORT/PG_USERNAME/PG_PASSWORD/PG_DATABASE`         | 分别指定 PostgreSQL 连接                                                                                                                                                                                | 仅当未提供 `DATABASE_URL`    |
| `REDIS_HOST/REDIS_PORT/REDIS_PASSWORD`                        | 本地 Redis 配置                                                                                                                                                                                         | 仅当未提供 `REDIS_URL`       |
| `UPSTASH_REDIS_REST_URL`                                      | 事件流可选 REST 端点                                                                                                                                                                                    | 事件聚合回退日志               |
| `EXPERIMENTS_ENABLED` / `EXPERIMENT_LOG_ENDPOINT`           | A/B 实验开关与日志上报                                                                                                                                                                                  | 可选                           |
| `METRICS_STATSD_HOST` / `METRICS_STATSD_PORT`               | StatsD 指标上报                                                                                                                                                                                         | 可选                           |
| `NEO4J_ENDPOINT/NEO4J_USERNAME/NEO4J_PASSWORD/NEO4J_DATABASE` | 图召回客户端                                                                                                                                                                                            | 未配置则跳过图召回             |
| `FAISS_EXPORT_DIR`                                            | 特征导出目录                                                                                                                                                                                            | 可选                           |

### 前端（Vite）

> `.env.example` 提供了基础项，但代码同时读取下列变量；请补齐命名保持一致（可与后端共用同一份 `.env`）。

| 变量                      | 作用                                          | 默认值                                                        |
| ------------------------- | --------------------------------------------- | ------------------------------------------------------------- |
| `VITE_API_BASE_URL`     | REST API 基址（不含 `/api`）                | `https://telegram-clone-backend-88ez.onrender.com`          |
| `VITE_SOCKET_URL`       | 主 Socket.IO 地址                             | 同上                                                          |
| `VITE_AI_SOCKET_URL`    | AI Socket.IO 地址                             | （AI Socket 生产已禁用；如启用请填写云端 AI Socket 域名）     |
| `VITE_ANN_ENDPOINT`     | ML 召回服务                                   | `https://telegram-ml-services.onrender.com/ann/retrieve`    |
| `VITE_PHOENIX_ENDPOINT` | ML 排序服务                                   | `https://telegram-ml-services.onrender.com/phoenix/predict` |
| `VITE_VF_ENDPOINT`      | ML 安全过滤                                   | `https://telegram-ml-services.onrender.com/vf/check`        |
| `VITE_API_URL`          | （仅智能回复回退）API 完整前缀（含 `/api`） | `https://telegram-clone-backend-88ez.onrender.com/api`      |

> 备注：`frontend/.env.example` 使用 `VITE_WS_URL`，实际代码读取 `VITE_SOCKET_URL`，建议同时设置两者或更新示例文件。

### ML 服务

| 变量                      | 作用                                   | 默认                                                 |
| ------------------------- | -------------------------------------- | ---------------------------------------------------- |
| `PORT`                  | FastAPI 服务端口                       | `8000`（由 Dockerfile 设置，可被 Render 注入）     |
| `FAISS_INDEX_TYPE`      | FAISS 索引类型                         | `ivf_pq`                                           |
| `FAISS_NPROBE`          | IVF nprobe                             | `16`                                               |
| `USE_FAISS`             | 是否启用 FAISS                         | `true`                                             |
| `DRIVE_ID_TWO_TOWER_50` | Google Drive 文件 ID（Two-Tower 权重） | 1PzT1elcXRPjlIswEma7tJK3ciftaLMlY                    |
| `DRIVE_ID_PHOENIX_3`    | Google Drive 文件 ID（Phoenix 权重）   | 1bODZspZX98RLKxzxLOLoe2yxg_QQ3dUf                    |
| `API_ENDPOINT`          | 后端聚合数据接口（自动重训脚本）       | `https://telegram-clone-backend-88ez.onrender.com` |
| `REDIS_URL`             | 事件流/重训练可选                      | 空则仅日志                                           |
| `BACKEND_URL`           | 新闻爬虫推送地址                       | `https://telegram-clone-backend-88ez.onrender.com` |

## 后端服务（telegram-clone-backend）

- 入口：`src/index.ts`；TypeScript 编译到 `dist/`，`npm start` 运行 `dist/index.js`。
- 构建/启动脚本：`npm run dev`（nodemon 热重载）、`npm run build`（先安装 dev 依赖再 `tsc`）、`npm start`（生产）。
- HTTP 配置：`PORT`；JSON 与表单体积上限 50MB；静态文件 `/api/uploads/*` 需 Bearer Token，路径映射 `uploads/`。
- CORS：允许本地 `3000/5173/5174`、Vercel 域及预览（见 `src/middleware/cors.ts`）。
- 健康检查：`GET /health` 并发检测 Mongo / Postgres / Redis / Gemini KEY，异常返回 `206/503`。
- 数据库：
  - MongoDB via `MONGODB_URI`，可调超时、池大小、IPv4 优先、TLS 证书等（`src/config/db.ts`）。
  - PostgreSQL 优先用 `DATABASE_URL` + SSL，或 `PG_*`；启动时 `sequelize.sync`（开发 `alter`，生产仅创建）。
- Redis：`REDIS_URL` 供 BullMQ 队列、Redis Pub/Sub、事件流、缓存；BullMQ 队列名称见 `queueService.ts`。
- AI Socket：单独 HTTP+Socket.IO 服务器（`src/aiSocketServer.ts`），端口 `AI_SOCKET_PORT`，可通过 `AI_SOCKET_ENABLED=false` 关闭。
- 推荐/ML 联动：
  - `ANN_ENDPOINT` -> Two-Tower 召回 HTTP 客户端。
  - `PHOENIX_ENDPOINT` -> PhoenixScorer 远程打分。
  - `VF_ENDPOINT` -> SafetyFilter 远程内容过滤。
- 其他可选：StatsD 指标上报、Neo4j 图召回、实验日志、FAISS 特征导出目录等仅在设置对应环境变量后生效。
- 部署：`render.yaml`（Node runtime、region singapore、build `npm install --include=dev && npm run build`，start `npm start`，健康检查 `/health`，`NODE_OPTIONS=--dns-result-order=ipv4first`）。
- 数据持久化：`uploads/`（用户上传）、数据库自身；无持久化的进程内状态。

## 前端（telegram-clone-frontend）

- 技术栈：React 19 + Vite 7 + TypeScript，状态管理 `zustand`，动画 `framer-motion`，图表 `recharts`，Socket.IO 客户端。
- 脚本：`npm run dev`（默认 `5173`）、`npm run build`、`npm run preview`、`npm run lint`、`npm run test`（Vitest/JSdom）。
- 配置：`vite.config.ts` 设置 `envDir: '..'` 读取根 `.env`；输出目录 `dist/`。ESLint 配置在 `eslint.config.js`。
- 部署：`vercel.json` 设定 `buildCommand: npm run build`，输出 `dist`，并将所有路径重写到 `/index.html`（SPA）。
- 运行时配置入口：各服务文件读取 `VITE_*` 变量；AI Socket 断线会自动回退 HTTP `/api/ai/chat`。

## ML 推理与训练服务（ml-services）

- 核心服务：`app.py` FastAPI，端点 `/health`、`/ann/retrieve`（Two-Tower 召回）、`/phoenix/predict`（排序）、`/vf/check`/`/vf/check/v2`（安全过滤），默认 CPU 推理。
- 模型/索引：期望 `data/` 下的词表与嵌入、`models/` 下的权重；若设置了 `DRIVE_ID_*` 会自动用 gdown 下载缺失模型。
- 依赖：见 `requirements.txt`（torch/transformers/faiss/fastapi/uvicorn/newspaper3k 等）。
- Docker：`Dockerfile` 基于 `python:3.11-slim`，安装依赖后 `uvicorn app:app --host 0.0.0.0 --port $PORT`，默认用户 `appuser`。
- 脚本：
  - 预处理/训练：`scripts/preprocess_mind.py`、`train_two_tower.py`、`train_phoenix.py`。
  - 索引：`scripts/build_faiss_index.py`。
  - 自动重训：`scripts/auto_retrain.py` 需 `API_ENDPOINT` / 可选 `REDIS_URL`。
  - 新闻爬虫：`crawler/news_fetcher.py` 依赖 `BACKEND_URL` 推送到 `/api/space/posts/batch-news`。
- 数据落地：`data/`、`models/` 需持久化；推理时优先加载 FAISS 索引，缺失则使用 PyTorch 全量检索回退。

## 跨服务联动要点

- 前端与后端：`VITE_API_BASE_URL` / `VITE_SOCKET_URL` 指向 `https://telegram-clone-backend-88ez.onrender.com`（云端部署）；前端所有 API 请求自动携带 Bearer Token（localStorage）。
- 后端与 ML：确保 `ANN_ENDPOINT`、`PHOENIX_ENDPOINT`、`VF_ENDPOINT` 指向 `ml-services` 对应路由；若未配置则后端使用本地启发式回退，效果受限。
- AI Socket：如生产环境关闭 AI Socket（`AI_SOCKET_ENABLED=false`），前端会自动降级 HTTP，无需额外配置。

## 更细粒度的架构与数据流

### 前端深化
- 目录速览：`components/chat`（窗口、气泡、输入、长列表虚拟化），`components/auth`（登录/注册表单），`context`（Auth/Socket），`services`（REST/WS/ML/加密/空间/分析），`hooks`（useSocket/useAuth/useMessages），`pages`（Login/Register/Chat），`styles`（CSS Modules + 全局样式）。  
- 通讯链路：`apiClient.ts` 统一 axios 并自动刷新令牌；`socketService.ts` 负责主聊天 WS 连接、认证重连；`aiSocketService.ts` 针对 AI，对应 `VITE_AI_SOCKET_URL`，断线自动回退 HTTP；`mlService.ts` 面向 ANN/Phoenix/VF/Smart Replies。  
- 安全与加密：前端存储 Signal 密钥（`signalKeyStore.ts`），配合后端 `/api/keys` 路由；消息在 WS 层携带 JWT，上传/下载文件通过受保护的 `/api/uploads`。  
- 体验优化：`@tanstack/react-virtual` 处理长消息列表；`framer-motion` 为侧栏/消息过渡提供动效；`recharts` 展示分析/实验结果。

### 后端深化
- 路由分层：\n  - 认证 `/api/auth/*`；AI `/api/ai/*` + `/api/ai-chat/*`；消息 `/api/messages/*`；联系人 `/api/contacts/*`；群组 `/api/groups/*`；文件 `/api/upload` + `/api/uploads/*`；Signal 密钥 `/api/keys/*`；同步 `/api/sync/*`；空间流 `/api/space/*`；分析 `/api/analytics/*`；特征存储 `/api/features/*`。  
- 中间件/限流：`rateLimiter` 针对 AI 路由保护；`authMiddleware` 支持 header/query token；`cors` 指定 Vercel 域与调试端口；`logger` 提供结构化日志，开发态更详细。  
- 数据模型亮点：\n  - `User`（PostgreSQL）具用户名/邮箱唯一索引与密码校验；`Contact`、`Group`、`GroupMember` 维护社交关系；`UserKey`/`OneTimePreKey`/`UserSignal` 存储 Signal 密钥；`UserFeatureVector`、`ClusterDefinition`、`RealGraphEdge` 支撑推荐/图召回；`AiConversation`（Mongo）存储多模态 AI 对话。  
  - `Message`（Mongo）包含类型/状态枚举、软删除、编辑、文件元数据、全文索引；静态方法支持对话/群组分页、已读批量更新。  
- 实时消息流水：客户端发送 WS `sendMessage` → 验证 JWT → 写入 Mongo → Redis Pub/Sub 广播 → 目标用户房间推送；已读回执更新 Mongo，并广播给发送方。队列与缓存可跨多实例扩展（Redis 适配器）。  
- AI 聊天流水：AI Socket 或 HTTP `/api/ai/chat` → 组装历史（`AiConversation` + 请求中的 history）→ 调用 Gemini 2.0 Flash（含图片 inline_data）→ 返回文本、token 用量、conversationId → 持久化用户/AI 消息。  
- 推荐/空间流水线：TwoTower 召回 (`ANN_ENDPOINT`) + Graph 召回（可选 Neo4j）→ SafetyFilter (`VF_ENDPOINT`) → PhoenixScorer (`PHOENIX_ENDPOINT`) 多目标预测 → Weighted/Ranking 组合打分 → 多样性与新鲜度选择 → `/api/space` 输出 feed。  
- 事件与分析：`eventStreamService` 将用户行为写入 Redis Stream；`analyticsRoutes` 支持导出窗口查询；`ExperimentService` 可按 `EXPERIMENTS_ENABLED` 控制；`FeatureExportJob`/`FAISS_EXPORT_DIR` 可将特征导出供向量索引。  
- 健康与运维：`/health` 聚合 Mongo/Postgres/Redis/Gemini 状态；Mongo/Redis 具重连与安全提示；优雅关闭捕获 SIGINT/SIGTERM。

### ML 服务深化
- 推理输入/输出：\n  - ANN：`{ userId, historyPostIds, keywords?, topK }` → `candidates[{postId, score}]`，FAISS 优先，缺失回退全量矩阵乘。  
  - Phoenix：`{ userId, userActionSequence?, candidates[] }` → `predictions[{postId, click, like, reply, repost, profileClick, share, dwell, dismiss, block}]`。  
  - VF：`{ items:[{postId,userId,content?}], skipML? }` → `results[{postId, safe, reason, level, score, violations, requiresReview}]`。  
- 模型加载流程：启动即加载 vocab、可选 gdown 下载权重、FAISS 索引（设 `nprobe`），失败则加载 `item_embeddings.npy` 作为后备；设备固定 CPU，保障云平台稳定。  
- 自动重训：`auto_retrain.py` 读取后端 `/api/analytics/events/export` 聚合事件，构建 64 维扩展特征，微调 Phoenix（Adam + MSE，低学习率），保存为 `phoenix_epoch_*.pt`。  
- 数据抓取/主题聚类：`crawler/news_fetcher.py` 定时抓取 RSS → SentenceTransformer `all-MiniLM-L6-v2` 生成 embedding → KMeans 动态聚类 → 调用 `BACKEND_URL/api/space/posts/batch-news` 批量推送。  
- 部署与资源：Render/容器平台使用 `python:3.11-slim` + 非 root 用户 `appuser`，端口取自环境变量；需持久化 `data/` 与 `models/` 以避免每次冷启动重新下载。

### 部署与环境一致性
- 前端：Vercel（`buildCommand: npm run build`，输出 `dist`），运行时通过 `VITE_*` 注入云端 API/Socket/ML 地址。  
- 后端：Render blueprint `render.yaml`（region singapore，build `npm install --include=dev && npm run build`，start `npm start`，健康检查 `/health`，`NODE_OPTIONS=--dns-result-order=ipv4first`）。  
- ML：容器镜像或 Render 私有服务，依赖 `DRIVE_ID_*` 下载权重；`PORT` 由平台注入。  
- 配置来源单一：根 `.env` 已包含生产域名与密钥，前后端/ML 均通过环境变量消费，无本地硬编码地址。
