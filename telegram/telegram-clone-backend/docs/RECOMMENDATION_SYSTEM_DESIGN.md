# Telegram 克隆项目 - 推荐系统设计

基于 X (Twitter) "For You" 推荐算法的简化实现，适配即时通讯场景。

## 🎯 核心思想

X 的推荐算法核心理念：
1. **无手工特征工程** - 让模型从用户行为中学习
2. **多行为预测** - 预测多种互动类型（点赞、回复、转发等）
3. **加权评分** - 正面行为正权重，负面行为负权重
4. **候选隔离** - 每个候选独立评分，不互相影响

## 📊 适配 Telegram 场景

### 推荐目标

| X 平台 | Telegram 场景 |
|--------|--------------|
| 推荐帖子 | 推荐联系人/群组/消息优先级 |
| 点赞/转发 | 回复/发起聊天/加入群组 |
| 浏览时长 | 消息阅读时长/会话停留时长 |
| 关注作者 | 添加联系人/关注群组 |
| 屏蔽/静音 | 屏蔽用户/静音群组 |

### 系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      RECOMMENDATION REQUEST                             │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          RECOMMENDATION SERVICE                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                        用户行为序列获取                             │  │
│  │  • 最近互动历史 (消息、回复、已读状态)                              │  │
│  │  • 用户偏好设置 (联系人、群组、屏蔽列表)                            │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                  │                                       │
│                                  ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                         候选源获取                                  │  │
│  │  ┌─────────────────────┐    ┌─────────────────────────────────┐    │  │
│  │  │     In-Network      │    │        Out-of-Network           │    │  │
│  │  │   (联系人会话)       │    │      (推荐新联系人/群组)         │    │  │
│  │  │                     │    │                                 │    │  │
│  │  │  已有联系人的会话    │    │  共同好友/相似用户/公开群组      │    │  │
│  │  └─────────────────────┘    └─────────────────────────────────┘    │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                  │                                       │
│                                  ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                          过滤器                                     │  │
│  │  • 移除已屏蔽用户                                                   │  │
│  │  • 移除已静音群组                                                   │  │
│  │  • 去重                                                             │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                  │                                       │
│                                  ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                          评分系统                                   │  │
│  │                                                                     │  │
│  │  Score = Σ (weight_i × P(action_i))                                │  │
│  │                                                                     │  │
│  │  正面信号:                          负面信号:                       │  │
│  │  • reply_score × 1.0               • block_score × -10.0          │  │
│  │  • read_score × 0.5                • mute_score × -5.0            │  │
│  │  • chat_frequency × 0.8            • ignore_score × -2.0          │  │
│  │  • mutual_friends × 0.3                                            │  │
│  │  • recency_score × 0.7                                             │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                  │                                       │
│                                  ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                        选择 & 排序                                  │  │
│  │  按分数排序，选择 Top K 返回                                        │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       RANKED RECOMMENDATIONS                             │
└─────────────────────────────────────────────────────────────────────────┘
```

## 📁 实现文件结构

```
src/
├── models/
│   └── UserInteraction.ts          # 用户互动追踪模型
├── services/
│   ├── recommendationService.ts    # 推荐核心服务
│   ├── scoringService.ts           # 评分计算服务
│   └── candidateService.ts         # 候选源服务
├── routes/
│   └── recommendationRoutes.ts     # 推荐 API 路由
└── config/
    └── recommendationWeights.ts    # 评分权重配置
```

## 🔄 数据流

### 1. 用户互动追踪

每次用户行为都会记录：
- 发送消息
- 阅读消息
- 回复消息
- 添加/删除联系人
- 加入/退出群组
- 屏蔽/静音操作

### 2. 评分公式

```typescript
// 基于 X 算法的加权评分
const calculateScore = (candidate, userHistory) => {
  const scores = {
    // 正面信号
    replyFrequency: getReplyFrequency(candidate, userHistory) * WEIGHTS.REPLY,
    messageFrequency: getMessageFrequency(candidate, userHistory) * WEIGHTS.MESSAGE,
    readRate: getReadRate(candidate, userHistory) * WEIGHTS.READ,
    recency: getRecencyScore(candidate) * WEIGHTS.RECENCY,
    mutualContacts: getMutualContacts(candidate, userHistory) * WEIGHTS.MUTUAL,
    
    // 负面信号
    ignoreRate: getIgnoreRate(candidate, userHistory) * WEIGHTS.IGNORE,
    blockSignal: isBlocked(candidate) ? WEIGHTS.BLOCK : 0,
    muteSignal: isMuted(candidate) ? WEIGHTS.MUTE : 0,
  };
  
  return Object.values(scores).reduce((sum, score) => sum + score, 0);
};
```

### 3. 权重配置

```typescript
// config/recommendationWeights.ts
export const WEIGHTS = {
  // 正面权重 (正数)
  REPLY: 1.0,
  MESSAGE: 0.8,
  READ: 0.5,
  RECENCY: 0.7,
  MUTUAL: 0.3,
  
  // 负面权重 (负数)
  IGNORE: -2.0,
  BLOCK: -10.0,
  MUTE: -5.0,
};
```

## 🚀 使用场景

### 1. 聊天列表排序
按互动亲密度和最近活跃度对会话排序

### 2. 联系人推荐
基于共同好友和相似互动模式推荐新联系人

### 3. 群组推荐
根据用户兴趣和好友参与度推荐公开群组

### 4. 消息优先级
在群组中高亮显示与用户最相关的消息

## 📈 后续优化

1. **机器学习模型** - 使用 TensorFlow.js 训练个性化模型
2. **实时特征** - Redis 存储实时互动计数
3. **A/B 测试** - 不同权重配置的效果对比
4. **冷启动** - 新用户的推荐策略

